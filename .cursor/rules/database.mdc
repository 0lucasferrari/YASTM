---
description: Database conventions for migrations, queries, and schema changes.
globs: src/infrastructure/database/**
---

# Database Conventions

Reference: `docs/database-schema.md`

## General Rules

- **PostgreSQL** and **MySQL 8** are both supported. The driver is set via the `DB_CLIENT` env variable (`pg` or `mysql2`).
- **Knex.js** is the query builder — never write raw SQL unless Knex cannot express the query.
- All primary keys are **UUIDs** generated application-side (using the `uuid` package).
- All timestamps use `table.timestamp(name, { useTz: true })` (Knex generates `timestamptz` for PG, `timestamp` for MySQL).
- **Never use database-specific features** without a dialect check (`knex.client.config.client`).

## Audit Columns

Every entity table must include:

```
created_at  timestamp    NOT NULL DEFAULT now()
created_by  uuid         FK → users(id), nullable
updated_at  timestamp    NOT NULL DEFAULT now()
updated_by  uuid         FK → users(id), nullable
deleted_at  timestamp    nullable
deleted_by  uuid         FK → users(id), nullable
```

## Soft Deletes

- Never use SQL `DELETE`. Always set `deleted_at = now()` and `deleted_by = userId`.
- All queries must filter `WHERE deleted_at IS NULL` unless explicitly querying deleted records.

## Migrations

- File naming: `{timestamp}_{description}.ts` (e.g. `20260216120000_create_users.ts`)
- Each migration must have both `up()` and `down()` functions.
- Respect foreign key dependency order (see `docs/database-schema.md` → Migration Order).
- The `task_priority` enum is dialect-aware:
  - **PostgreSQL:** Uses a custom `CREATE TYPE task_priority AS ENUM (...)`.
  - **MySQL 8:** Uses an inline `table.enum()` column definition (no separate type).
- When a migration needs dialect-specific logic, use `knex.client.config.client` to branch:

```typescript
const client = knex.client.config.client;
if (client === 'pg') {
  // PostgreSQL-specific code
} else {
  // MySQL-specific code
}
```

## Junction Tables

Junction tables (`task_assignees`, `task_statuses`, `task_labels`) use composite primary keys. They do NOT have audit columns.
